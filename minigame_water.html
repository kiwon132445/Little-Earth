<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Stop the water!</title>
        <link rel="stylesheet" href="./CSS/minigameWater.css">
        <script src="https://www.gstatic.com/firebasejs/5.8.4/firebase.js"></script>
        <script src="./JS/setup_firebase.js"></script>
    </head>
    <body>
        <div class="main">
            <div class="horizontal">
                <img id="tap" src="./CSS/images/watertap.png" alt="game">
                <div class="water"><div id="waterFlow" style="width:100%;"></div></div>
                <div class="remainingWaterBar"><div class="remainingWater" style="height:0%;"></div></div>
                <button type="button" class="exit" onclick="exitButton()">X</button>
            </div>
            <div class="buttons">
                <button type="button" onclick="openTap()" class="gameB">Open the Tap!</button>
                <button type="button" onclick="closeTap()" class="gameB">Close the Tap!</button>
            </div>
            <div class="valveLevelBar">
                <div id="valveLevel" style="width:100%;">
                </div>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.3.1.slim.js"></script>
        <script src="./JS/game_logic.js"></script>
        <script>
                    let valve = document.getElementById("valveLevel");
                    let valveWidth = parseInt(valve.style.width.split("%")[0]);

                    let waterFlow = document.getElementById("waterFlow");

                    let waterLevel = document.getElementsByClassName("remainingWater")
                    let waterLevelContainer = document.getElementsByClassName("remainingWaterBar");
                    let waterLevelHeight = parseInt($(waterLevel).height()/$(waterLevelContainer).height() * 100);

                    alert("Are you ready?");
                    let intervalId = setInterval(openTap, 400);
                    let decreaseInterval = setInterval(waterDecrease, 200);
                    
                    function openTap() {
                        if (valveWidth < 100) {
                            valveWidth += 5;
                            valve.style.width = valveWidth + "%";
                            waterFlowLevel();
                        }
                        
                    }
                    function closeTap() {
                        if (valveWidth > 0) {
                            valveWidth -= 5;
                            valve.style.width = valveWidth + "%";
                            waterFlowLevel();
                            cancelInterval();
                        }
                    }
                    
                    //close game
                    function cancelInterval() {
                        if (valveWidth <= 0 || waterLevelHeight >= 100) {
                            clearInterval(intervalId);
                            clearInterval(decreaseInterval);
                            win();
                            document.getElementsByClassName("gameB")[0].setAttribute("disabled", "disabled");
                            document.getElementsByClassName("gameB")[1].setAttribute("disabled", "disabled");
                        }
                    }
                    //water width
                    function waterFlowLevel() {
                        waterFlow.style.width = valveWidth + "%";
                    }

                    //decrease remaining water
                    function waterDecrease() {
                        if (waterLevelHeight < 100) {
                            waterLevelHeight++;
                            $(waterLevel).height(waterLevelHeight + "%");
                        }
                        cancelInterval()
                        lose();
                    }
                    //win
                    function win() {
                        if (valveWidth <= 0 && waterLevelHeight < 100) {
                            let experienceUpdated = increaseExperience(10);
                            experienceUpdated.then(function(){
                                increaseLifespan(25).then(function(){
                                    let win = new Promise(function(resolve, reject) {
                                        setTimeout(() => resolve(alert("You won! Earth gains back 25000 points of its lifespan")), 100);
                                    });
                                    win.then(
                                        result => window.location.href = "main.html"
                                    );
                                });
                            });
                        }
                    }
                    //lose
                    function lose() {
                        if (valveWidth > 0 && waterLevelHeight >= 100) {
                            decreaseLifespan(15).then(function(){
                                let lose = new Promise(function(resolve, reject) {
                                    setTimeout(() => resolve(alert("You Lost! Earth lost 15000 points of its lifespan")), 100);
                                });
                                lose.then(
                                    result => window.location.href = "main.html"
                                ); 
                            });
                        }
                    }
                    function exitButton() {
                        let exitConfirm = confirm("Earth will lose 15000 points of its lifespan. \nWill you exit game?");
                        if (exitConfirm == true) {
                            decreaseLifespan(15).then(function(){
                                window.location.href = "main.html";
                            });
                        }
                    }
        </script>
    </body>
</html>